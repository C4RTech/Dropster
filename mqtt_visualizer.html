<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador MQTT AWG</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .connecting { background: #fff3cd; color: #856404; }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .data-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .data-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .data-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .data-unit {
            font-size: 0.9em;
            color: #666;
        }
        .timestamp {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }
        
        .messages {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .message {
            margin: 2px 0;
            word-wrap: break-word;
        }
        .topic { color: #ff0; }
        .data { color: #0ff; }
        .error { color: #f00; }
        
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåä Visualizador MQTT - AWG Dropster</h1>
        
        <div id="status" class="status disconnected">
            ‚ùå Desconectado del broker MQTT
        </div>
        
        <div class="controls">
            <button id="connectBtn" onclick="toggleConnection()">Conectar</button>
            <button id="clearBtn" onclick="clearMessages()">Limpiar Log</button>
            <button onclick="sendCommand('GET_STATUS')">Obtener Estado</button>
            <button onclick="sendCommand('GET_DATA')">Solicitar Datos</button>
        </div>
        
        <div class="data-grid" id="dataGrid">
            <!-- Los datos aparecer√°n aqu√≠ -->
        </div>
        
        <h3>üì° Log de Mensajes MQTT</h3>
        <div id="messages" class="messages">
            <div class="message">Esperando conexi√≥n...</div>
        </div>
    </div>

    <script>
        let client = null;
        let isConnected = false;
        let latestData = {};

        const BROKER_URL = 'wss://test.mosquitto.org:8081';
        const TOPICS = {
            data: 'awg/data',
            status: 'awg/status',
            control: 'awg/control',
            heartbeat: 'awg/heartbeat'
        };

        function updateStatus(message, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${className}`;
        }

        function addMessage(message, className = '') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        function connect() {
            updateStatus('üîÑ Conectando...', 'connecting');
            addMessage('Conectando a ' + BROKER_URL);
            
            try {
                client = mqtt.connect(BROKER_URL);
                
                client.on('connect', () => {
                    isConnected = true;
                    updateStatus('‚úÖ Conectado al broker MQTT', 'connected');
                    document.getElementById('connectBtn').textContent = 'Desconectar';
                    addMessage('‚úÖ Conectado exitosamente');
                    
                    // Suscribirse a todos los topics
                    Object.values(TOPICS).forEach(topic => {
                        client.subscribe(topic);
                        addMessage(`üì° Suscrito a: ${topic}`, 'topic');
                    });
                });
                
                client.on('message', (topic, message) => {
                    const payload = message.toString();
                    addMessage(`üì® [${topic}] ${payload}`, 'data');
                    
                    // Procesar datos JSON
                    if (topic === TOPICS.data) {
                        try {
                            const data = JSON.parse(payload);
                            latestData = data;
                            updateDataDisplay(data);
                        } catch (e) {
                            addMessage(`‚ùå Error parsing JSON: ${e.message}`, 'error');
                        }
                    }
                });
                
                client.on('error', (error) => {
                    addMessage(`‚ùå Error: ${error.message}`, 'error');
                    updateStatus('‚ùå Error de conexi√≥n', 'disconnected');
                });
                
                client.on('close', () => {
                    isConnected = false;
                    updateStatus('‚ùå Desconectado del broker MQTT', 'disconnected');
                    document.getElementById('connectBtn').textContent = 'Conectar';
                    addMessage('‚ùå Conexi√≥n cerrada');
                });
                
            } catch (error) {
                addMessage(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                updateStatus('‚ùå Error de conexi√≥n', 'disconnected');
            }
        }

        function disconnect() {
            if (client) {
                client.end();
                isConnected = false;
                updateStatus('‚ùå Desconectado del broker MQTT', 'disconnected');
                document.getElementById('connectBtn').textContent = 'Conectar';
                addMessage('üîå Desconectado manualmente');
            }
        }

        function sendCommand(command) {
            if (!isConnected || !client) {
                addMessage('‚ùå No conectado al broker', 'error');
                return;
            }
            
            client.publish(TOPICS.control, command);
            addMessage(`üì§ Comando enviado: ${command}`, 'topic');
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function updateDataDisplay(data) {
            const dataGrid = document.getElementById('dataGrid');
            
            const sensors = [
                { key: 'temperaturaAmbiente', label: 'Temperatura Ambiente', unit: '¬∞C', color: '#e74c3c' },
                { key: 'humedadRelativa', label: 'Humedad Relativa', unit: '%', color: '#3498db' },
                { key: 'presionAtmosferica', label: 'Presi√≥n Atmosf√©rica', unit: 'hPa', color: '#9b59b6' },
                { key: 'aguaAlmacenada', label: 'Agua Almacenada', unit: 'L', color: '#1abc9c' },
                { key: 'puntoRocio', label: 'Punto de Roc√≠o', unit: '¬∞C', color: '#f39c12' },
                { key: 'voltaje', label: 'Voltaje', unit: 'V', color: '#e67e22' },
                { key: 'corriente', label: 'Corriente', unit: 'A', color: '#2ecc71' },
                { key: 'potencia', label: 'Potencia', unit: 'W', color: '#34495e' }
            ];
            
            dataGrid.innerHTML = sensors.map(sensor => {
                const value = data[sensor.key] || 0;
                return `
                    <div class="data-card" style="border-left-color: ${sensor.color}">
                        <h3>${sensor.label}</h3>
                        <div class="data-value" style="color: ${sensor.color}">
                            ${typeof value === 'number' ? value.toFixed(2) : value}
                            <span class="data-unit">${sensor.unit}</span>
                        </div>
                        <div class="timestamp">Actualizado: ${data.timestamp || 'N/A'}</div>
                    </div>
                `;
            }).join('');
        }

        // Auto-conectar al cargar la p√°gina
        window.onload = () => {
            addMessage('üöÄ Visualizador MQTT iniciado');
            addMessage('üí° Haz clic en "Conectar" para comenzar');
        };
    </script>
</body>
</html>
